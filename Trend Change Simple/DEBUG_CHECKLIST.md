# ЧЕК-ЛИСТ ДЛЯ ОТЛАДКИ ТОРГОВОГО РОБОТА

## 1. ИНИЦИАЛИЗАЦИЯ

### Проверка диапазона:
- [ ] Диапазон корректно рассчитан (High/Low предыдущего дня 16:00-00:00)
- [ ] Границы диапазона логичны (High > Low)
- [ ] Breakout distance корректно рассчитан

### Проверка начального положения цены:
- [ ] Цена корректно получена (Bid/Ask)
- [ ] Цена выше/ниже/в диапазоне определена правильно
- [ ] `canTradeUp`/`canTradeDown` установлены правильно:
  - Если цена **в диапазоне** → `canTradeUp = true`, `canTradeDown = true`
  - Если цена **ниже диапазона** → `canTradeUp = true`, `canTradeDown = false`
  - Если цена **выше диапазона** → `canTradeUp = false`, `canTradeDown = true`

## 2. ПОИСК СИГНАЛОВ (ProcessSignalSearch)

### Проверка пробоя ВНИЗ:
- [ ] Цена выходит ниже диапазона на `breakoutDistance`
- [ ] Условие `currentPrice < (rangeLow - breakoutDistance)` срабатывает
- [ ] `downBreakoutDetected = true` устанавливается
- [ ] `canTradeDown = false` устанавливается
- [ ] Время пробоя сохраняется

### Проверка пробоя ВВЕРХ:
- [ ] Цена выходит выше диапазона на `breakoutDistance`
- [ ] Условие `currentPrice > (rangeHigh + breakoutDistance)` срабатывает
- [ ] `upBreakoutDetected = true` устанавливается
- [ ] `canTradeUp = false` устанавливается
- [ ] Время пробоя сохраняется

### Проверка истечения времени пробоев:
- [ ] `ForceExpireBreakouts()` вызывается на каждом тике
- [ ] Если прошло > 3 часов с момента пробоя → флаги сбрасываются
- [ ] Если `currentTime < breakoutTime` → флаги сбрасываются (защита от некорректного времени)

### Проверка возврата после пробоя ВНИЗ → BUY:
- [ ] `downBreakoutDetected = true`
- [ ] Цена возвращается в диапазон (`currentPrice >= (rangeLow + onePoint)`)
- [ ] Время между пробоем и возвратом ≤ 3 часов
- [ ] `OpenBuyPosition()` вызывается
- [ ] `ResetBreakoutFlags()` вызывается
- [ ] `systemState = STATE_POSITION_OPEN` устанавливается

### Проверка возврата после пробоя ВВЕРХ → SELL:
- [ ] `upBreakoutDetected = true`
- [ ] Цена возвращается в диапазон (`currentPrice <= (rangeHigh - onePoint)`)
- [ ] Время между пробоем и возвратом ≤ 3 часов
- [ ] `OpenSellPosition()` вызывается
- [ ] `ResetBreakoutFlags()` вызывается
- [ ] `systemState = STATE_POSITION_OPEN` устанавливается

## 3. ОТКРЫТИЕ ПОЗИЦИЙ

### OpenBuyPosition():
- [ ] Цена (Ask/Bid) корректно получена
- [ ] StopLoss и TakeProfit рассчитаны правильно
- [ ] `tradingOps.Buy()` вызывается
- [ ] Позиция успешно открывается

### OpenSellPosition():
- [ ] Цена (Bid/Ask) корректно получена
- [ ] StopLoss и TakeProfit рассчитаны правильно
- [ ] `tradingOps.Sell()` вызывается
- [ ] Позиция успешно открывается

## 4. ОБРАБОТКА ОТКРЫТОЙ ПОЗИЦИИ

### ProcessOpenPosition():
- [ ] Проверяется наличие открытой позиции
- [ ] Если позиция закрыта → вызывается `ProcessClosedPosition()`

## 5. ОБРАБОТКА ЗАКРЫТОЙ ПОЗИЦИИ

### ProcessClosedPosition():
- [ ] Причина закрытия определена правильно (TP/SL/BE)
- [ ] Если TP или BE без реверса → `systemState = STATE_BLOCKED_UNTIL_TOMORROW`
- [ ] Если SL или BE с реверсом → `ExecuteImmediateReversal()`

## 6. СМЕНА ДНЯ

### CheckNewDay():
- [ ] Новый день определен правильно
- [ ] Если `systemState == STATE_BLOCKED_UNTIL_TOMORROW` и наступил новый день:
  - `systemState = STATE_LOOKING_FOR_SIGNAL`
  - `ResetSystem()` вызывается
  - `ResetBreakoutFlags()` вызывается

## 7. КРИТИЧЕСКИЕ ЛОГИ ДЛЯ ПРОВЕРКИ

### Что должно логироваться обязательно:
1. **При инициализации:**
   - Границы диапазона
   - Начальная цена
   - Установка `canTradeUp`/`canTradeDown`

2. **При поиске сигнала:**
   - Текущая цена и границы диапазона
   - Состояние флагов пробоев
   - Условия срабатывания пробоев
   - Время пробоев

3. **При открытии позиции:**
   - Параметры позиции (лот, цена, SL, TP)
   - Результат открытия

4. **При закрытии позиции:**
   - Причина закрытия
   - Результат сделки
   - Новое состояние системы

5. **При смене дня:**
   - Сброс флагов
   - Новое состояние системы

## 8. ВОЗМОЖНЫЕ ПРОБЛЕМЫ И ИХ РЕШЕНИЯ

### Проблема: Ни одна сделка не открывается
**Проверь:**
- [ ] `canTradeUp`/`canTradeDown` не заблокированы
- [ ] Цена действительно выходит за границы на нужное расстояние
- [ ] Цена действительно возвращается в диапазон
- [ ] Время между пробоем и возвратом ≤ 3 часов
- [ ] `ProcessSignalSearch()` действительно вызывается
- [ ] `systemState == STATE_LOOKING_FOR_SIGNAL`

### Проблема: Сделки открываются спустя 6+ часов
**Проверь:**
- [ ] Флаги пробоев не истекают по времени
- [ ] `ForceExpireBreakouts()` не срабатывает
- [ ] Флаги `downBreakoutDetected`/`upBreakoutDetected` остаются активными

### Проблема: Ложные срабатывания
**Проверь:**
- [ ] Цена действительно выходит за границы на `breakoutDistance`, а не просто касается
- [ ] Цена действительно возвращается в диапазон, а не просто колеблется около границы
- [ ] Условия срабатывания не пересекаются

## 9. ТЕСТОВЫЕ СЦЕНАРИИ

### Сценарий 1: Цена внутри диапазона утром
1. Цена начинает день внутри диапазона
2. Выходит вниз на `breakoutDistance`
3. Возвращается в диапазон → открывается BUY
4. Закрывается по TP → блокируется до завтра

### Сценарий 2: Цена ниже диапазона утром
1. Цена начинает день ниже диапазона
2. `canTradeDown = false` (направление заблокировано)
3. Цена поднимается в диапазон и выходит вверх на `breakoutDistance`
4. Возвращается в диапазон → открывается SELL
5. Закрывается по TP → блокируется до завтра

### Сценарий 3: Цена выше диапазона утром
1. Цена начинает день выше диапазона
2. `canTradeUp = false` (направление заблокировано)
3. Цена опускается в диапазон и выходит вниз на `breakoutDistance`
4. Возвращается в диапазон → открывается BUY
5. Закрывается по TP → блокируется до завтра

### Сценарий 4: Цена выходит и не возвращается 3+ часов
1. Цена выходит за границы на `breakoutDistance`
2. Через 4 часа флаг пробоя истекает
3. Цена возвращается → сделка не открывается (флаг сброшен)

### Сценарий 5: Смена дня
1. Система заблокирована до завтра
2. Наступает новый день
3. Система разблокируется
4. Все флаги сбрасываются