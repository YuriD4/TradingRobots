# АНАЛИЗ БИЗНЕС-ЛОГИКИ ТОРГОВОГО РОБОТА TREND CHANGE SIMPLE

## ЦЕЛЬ СИСТЕМЫ
Отлавливать ложные пробои диапазона предыдущего дня (16:00-00:00) и открывать противоположные позиции при возврате цены в диапазон.

## ОСНОВНЫЕ ПРАВИЛА ОТКРЫТИЯ СДЕЛОК

### Когда открывается BUY (покупка):
1. Цена **выйдет НИЖЕ** диапазона на `breakoutPoints` расстояние
   - Т.е. `currentPrice < (rangeLow - breakoutDistance)`
2. Цена **вернется В диапазон** (выше `rangeLow + 1 пункт`)
   - Т.е. `currentPrice >= (rangeLow + onePoint)`
3. Между выходом и возвратом прошло **≤ 3 часов**
   - Т.е. `(время возврата - время выхода) <= 3 часа`

### Когда открывается SELL (продажа):
1. Цена **выйдет ВЫШЕ** диапазона на `breakoutPoints` расстояние
   - Т.е. `currentPrice > (rangeHigh + breakoutDistance)`
2. Цена **вернется В диапазон** (ниже `rangeHigh - 1 пункт`)
   - Т.е. `currentPrice <= (rangeHigh - onePoint)`
3. Между выходом и возвратом прошло **≤ 3 часов**
   - Т.е. `(время возврата - время выхода) <= 3 часа`

## БЛОКИРОВКИ ТОРГОВЛИ

### Блокировка направления ВНИЗ:
1. **В начале дня** если цена **уже НИЖЕ** диапазона → **блокируем торговлю вниз**
2. **После фактического открытия BUY** → **блокируем торговлю вниз до конца дня**

### Блокировка направления ВВЕРХ:
1. **В начале дня** если цена **уже ВЫШЕ** диапазона → **блокируем торговлю вверх**
2. **После фактического открытия SELL** → **блокируем торговлю вверх до конца дня**

## ПЕРЕМЕННЫЕ СОСТОЯНИЯ

### Флаги пробоев:
- `downBreakoutDetected` - был ли пробой вниз
- `upBreakoutDetected` - был ли пробой вверх
- `downBreakoutPrice` - цена пробоя вниз
- `upBreakoutPrice` - цена пробоя вверх
- `downBreakoutTime` - время пробоя вниз
- `upBreakoutTime` - время пробоя вверх

### Флаги разрешений на торговлю:
- `canTradeUp` - можно ли торговать вверх (SELL)
- `canTradeDown` - можно ли торговать вниз (BUY)

### Состояния системы:
- `STATE_LOOKING_FOR_SIGNAL` - ищем сигналы
- `STATE_POSITION_OPEN` - позиция открыта
- `STATE_BLOCKED_UNTIL_TOMORROW` - заблокировано до завтра

## ЛОГИКА РАБОТЫ ПО ШАГАМ

### 1. ИНИЦИАЛИЗАЦИЯ (OnInit):
- Определяем диапазон предыдущего дня (16:00-00:00)
- Проверяем начальное положение цены:
  - Если цена **ниже диапазона** → `canTradeDown = false`
  - Если цена **выше диапазона** → `canTradeUp = false`
  - Если цена **в диапазоне** → `canTradeUp = true`, `canTradeDown = true`

### 2. КАЖДЫЙ ТИК (OnTick):
- Проверяем, разрешена ли торговля по времени
- Проверяем смену дня
- Обновляем диапазон при новом баре
- В зависимости от состояния системы:
  - `STATE_LOOKING_FOR_SIGNAL` → вызываем `ProcessSignalSearch()`
  - `STATE_POSITION_OPEN` → вызываем `ProcessOpenPosition()`
  - `STATE_BLOCKED_UNTIL_TOMORROW` → ничего не делаем

### 3. ПОИСК СИГНАЛОВ (ProcessSignalSearch):
#### a) Проверка истечения времени пробоев:
- Если `downBreakoutDetected` и прошло > 3 часов → сбрасываем флаг
- Если `upBreakoutDetected` и прошло > 3 часов → сбрасываем флаг

#### b) Обнаружение пробоя ВНИЗ:
- Условия: `!downBreakoutDetected` И `currentPrice < (rangeLow - breakoutDistance)` И `canTradeDown`
- Действия: устанавливаем флаг `downBreakoutDetected = true` и блокируем `canTradeDown = false`

#### c) Обнаружение пробоя ВВЕРХ:
- Условия: `!upBreakoutDetected` И `currentPrice > (rangeHigh + breakoutDistance)` И `canTradeUp`
- Действия: устанавливаем флаг `upBreakoutDetected = true` и блокируем `canTradeUp = false`

#### d) Возврат после пробоя ВНИЗ → BUY:
- Условия: `downBreakoutDetected` И `currentPrice >= (rangeLow + onePoint)`
- Действия: проверяем время (≤ 3 часов) → `OpenBuyPosition()` → `ResetBreakoutFlags()` → `systemState = STATE_POSITION_OPEN`

#### e) Возврат после пробоя ВВЕРХ → SELL:
- Условия: `upBreakoutDetected` И `currentPrice <= (rangeHigh - onePoint)`
- Действия: проверяем время (≤ 3 часов) → `OpenSellPosition()` → `ResetBreakoutFlags()` → `systemState = STATE_POSITION_OPEN`

### 4. ОБРАБОТКА ОТКРЫТОЙ ПОЗИЦИИ (ProcessOpenPosition):
- Проверяем, есть ли еще открытая позиция
- Если позиция закрылась → вызываем `ProcessClosedPosition()`

### 5. ОБРАБОТКА ЗАКРЫТОЙ ПОЗИЦИИ (ProcessClosedPosition):
- Анализируем причину закрытия (TP/SL/BE)
- Если TP или BE (без реверса) → `systemState = STATE_BLOCKED_UNTIL_TOMORROW`
- Если SL или BE (с реверсом) → `ExecuteImmediateReversal()`

## ВОЗМОЖНЫЕ ПРОБЛЕМЫ И ИХ РЕШЕНИЯ

### Проблема 1: Ни одна сделка не открывается
**Возможные причины:**
1. Все флаги заблокированы
2. Цена никогда не выходит за границы диапазона на нужное расстояние
3. Цена выходит, но не возвращается в диапазон
4. Цена возвращается, но время > 3 часов
5. Система в заблокированном состоянии

**Проверки:**
- Логировать все состояния флагов
- Логировать цены и границы диапазона
- Логировать переходы между состояниями

### Проблема 2: Открываются ложные сделки после 6+ часов
**Причина:** Флаги пробоев не сбрасываются по истечении времени

**Решение:** Периодическая проверка времени в `ProcessSignalSearch()`

### Проблема 3: Система блокируется преждевременно
**Причина:** Неправильная установка `canTradeUp/canTradeDown` при инициализации

**Решение:** Проверять начальное положение цены правильно

## ЧЕК-ЛИСТ ДЛЯ ОТЛАДКИ

### При инициализации:
- [ ] Правильно определены границы диапазона
- [ ] Правильно определено начальное положение цены
- [ ] Правильно установлены `canTradeUp`/`canTradeDown`

### При поиске сигнала:
- [ ] Цена действительно выходит за границы на нужное расстояние
- [ ] Устанавливаются флаги пробоев
- [ ] Блокируются направления торговли
- [ ] Цена возвращается в диапазон
- [ ] Время между пробоем и возвратом ≤ 3 часов
- [ ] Открываются сделки

### При обработке закрытой позиции:
- [ ] Правильно определяется причина закрытия
- [ ] Правильно устанавливается новое состояние системы
- [ ] Сбрасываются флаги при необходимости

## КРИТИЧЕСКИЕ ЛОГИ ДЛЯ ОТЛАДКИ

1. **Инициализация:**
   - Начальное положение цены относительно диапазона
   - Установка `canTradeUp`/`canTradeDown`

2. **Поиск сигнала:**
   - Текущая цена и границы диапазона
   - Состояние флагов пробоев
   - Условия для установки флагов
   - Условия для открытия сделок

3. **Обработка закрытой позиции:**
   - Причина закрытия
   - Новое состояние системы
   - Сброс флагов

4. **Смена дня:**
   - Переход из заблокированного состояния в активное
   - Сброс всех флагов